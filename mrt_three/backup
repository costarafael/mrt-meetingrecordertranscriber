#!/bin/bash

# Script de Backup do Projeto Swift Recorder
# Cria um backup limpo excluindo arquivos tempor√°rios e de build

set -e  # Parar em caso de erro

# Configura√ß√µes
PROJECT_NAME="test_recorder_swift"
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
BACKUP_NAME="${PROJECT_NAME}_backup_${TIMESTAMP}"
TEMP_DIR="/tmp/${BACKUP_NAME}"
CURRENT_DIR=$(pwd)
PARENT_DIR=$(dirname "$CURRENT_DIR")
BACKUP_ZIP="${PARENT_DIR}/${BACKUP_NAME}.zip"

echo "üóÇÔ∏è  Iniciando backup do projeto..."
echo "üìÖ Timestamp: $TIMESTAMP"
echo "üìÅ Diret√≥rio atual: $CURRENT_DIR"
echo "üíæ Backup ser√° salvo em: $BACKUP_ZIP"

# Limpar diret√≥rio tempor√°rio se existir
if [ -d "$TEMP_DIR" ]; then
    echo "üßπ Limpando diret√≥rio tempor√°rio..."
    rm -rf "$TEMP_DIR"
fi

# Criar diret√≥rio tempor√°rio
mkdir -p "$TEMP_DIR"

echo "üìã Copiando arquivos (excluindo tempor√°rios e builds)..."

# Usar rsync para copiar com exclus√µes
rsync -av \
    --exclude='.build/' \
    --exclude='MacOSApp.app/' \
    --exclude='MacOSApp.dmg' \
    --exclude='.DS_Store' \
    --exclude='*.dmg' \
    --exclude='*.app' \
    --exclude='.git/' \
    --exclude='*.xcworkspace' \
    --exclude='*.xcodeproj' \
    --exclude='DerivedData/' \
    --exclude='*.swp' \
    --exclude='*.tmp' \
    --exclude='*~' \
    --exclude='.swiftpm/' \
    --exclude='*.lock' \
    --exclude='node_modules/' \
    --exclude='*.log' \
    --exclude='Thumbs.db' \
    --exclude='desktop.ini' \
    --exclude='*.onnx' \
    "$CURRENT_DIR/" "$TEMP_DIR/"

echo "üì¶ Criando arquivo ZIP..."

# Entrar no diret√≥rio pai do tempor√°rio para criar zip sem path completo
cd "$(dirname "$TEMP_DIR")"
zip -r "$BACKUP_ZIP" "$(basename "$TEMP_DIR")" > /dev/null

echo "üßπ Limpando arquivos tempor√°rios..."
rm -rf "$TEMP_DIR"

# Verificar se o backup foi criado com sucesso
if [ -f "$BACKUP_ZIP" ]; then
    BACKUP_SIZE=$(du -h "$BACKUP_ZIP" | cut -f1)
    echo "‚úÖ Backup criado com sucesso!"
    echo "üì¶ Arquivo: $BACKUP_ZIP"
    echo "üìè Tamanho: $BACKUP_SIZE"
    echo ""
    echo "üìã Conte√∫do do backup:"
    echo "   ‚Ä¢ C√≥digo fonte (Sources/)"
    echo "   ‚Ä¢ Configura√ß√µes (Package.swift, Info.plist)"
    echo "   ‚Ä¢ Documenta√ß√£o (*.md)"
    echo "   ‚Ä¢ Scripts e arquivos de configura√ß√£o"
    echo ""
    echo "‚ùå Exclu√≠dos:"
    echo "   ‚Ä¢ .build/ (arquivos de build)"
    echo "   ‚Ä¢ MacOSApp.app/ (aplica√ß√£o compilada)"
    echo "   ‚Ä¢ *.dmg (instaladores)"
    echo "   ‚Ä¢ .DS_Store (metadados do macOS)"
    echo "   ‚Ä¢ Arquivos tempor√°rios"
    echo "   ‚Ä¢ mrt_bcknd_macos_app/models/**/*.onnx (modelos de ML)"
else
    echo "‚ùå Erro: Backup n√£o foi criado!"
    exit 1
fi

echo "üéâ Backup conclu√≠do com sucesso!" 