# Fastfile para automatizar assinatura do Core Audio TAP XPC

default_platform(:mac)

platform :mac do
  desc "Configurar e assinar aplicaÃ§Ã£o para XPC real"
  lane :setup_xpc_real do
    puts "ğŸš€ Configurando Core Audio TAP XPC Real com Fastlane..."
    
    # 1. Verificar se hÃ¡ certificados de desenvolvimento
    begin
      certs = sh("security find-identity -v -p codesigning | grep 'Apple Development\\|Mac Developer'")
      if certs.empty?
        UI.user_error!("âŒ Nenhum certificado de desenvolvimento encontrado. Configure sua conta no Xcode primeiro.")
      end
      UI.success("âœ… Certificados encontrados")
    rescue
      UI.user_error!("âŒ Erro ao verificar certificados. Configure sua conta no Xcode.")
    end
    
    # 2. Compilar aplicaÃ§Ã£o
    puts "ğŸ”§ Compilando aplicaÃ§Ã£o..."
    sh("./build_production.sh")
    
    # 3. Configurar assinatura automÃ¡tica
    app_path = "MRTThree_Production.app"
    
    # Usar match para gerenciar certificados (opcional)
    # match(type: "development", app_identifier: "com.meetingrecorder.MRTThree")
    
    # 4. Assinar Helper Tool
    puts "âœï¸  Assinando Helper Tool..."
    sh("codesign --force --sign 'Apple Development' --options runtime '#{app_path}/Contents/Library/LaunchServices/AudioCaptureHelper'")
    
    # 5. Assinar aplicaÃ§Ã£o principal
    puts "âœï¸  Assinando aplicaÃ§Ã£o..."
    sh("codesign --force --sign 'Apple Development' --options runtime --deep '#{app_path}'")
    
    # 6. Verificar assinaturas
    puts "ğŸ” Verificando assinaturas..."
    sh("codesign -v '#{app_path}/Contents/Library/LaunchServices/AudioCaptureHelper'")
    sh("codesign -v '#{app_path}'")
    
    UI.success("ğŸ‰ XPC Real configurado e assinado com sucesso!")
    puts ""
    puts "ğŸš€ Teste executando: open #{app_path}"
  end
  
  desc "Verificar status de assinatura"
  lane :verify_signing do
    app_path = "MRTThree_Production.app"
    
    puts "ğŸ” Verificando status de assinatura..."
    
    begin
      sh("codesign -v -d '#{app_path}'")
      UI.success("âœ… AplicaÃ§Ã£o principal: Assinatura vÃ¡lida")
    rescue
      UI.error("âŒ AplicaÃ§Ã£o principal: Assinatura invÃ¡lida")
    end
    
    begin
      sh("codesign -v -d '#{app_path}/Contents/Library/LaunchServices/AudioCaptureHelper'")
      UI.success("âœ… Helper Tool: Assinatura vÃ¡lida")
    rescue
      UI.error("âŒ Helper Tool: Assinatura invÃ¡lida")
    end
  end
  
  desc "Limpar e recompilar tudo"
  lane :clean_rebuild do
    puts "ğŸ§¹ Limpando build anterior..."
    sh("rm -rf .build MRTThree_Production.app")
    
    puts "ğŸ”§ Recompilando..."
    sh("./build_production.sh")
    
    UI.success("âœ… Rebuild completo")
  end
end